<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css"
        integrity="sha384-SZXxX4whJ79/gErwcOYf+zWLeJdY/qpuqC4cAa9rOGUstPomtqpuNWT9wdPEn2fk" crossorigin="anonymous">
    <link rel="stylesheet" href="./style/style.css">
    <title>Video downloader</title>
</head>

<body>
    <section id="mainSection">
        <div class="container">

            <div class="header">
                <h1>Youtube video downloader</h1>
            </div>
            <div class="form">
                <div class="form-item">
                    <label for="videoUrl">Enter link of video</label>
                    <input onClick="this.select();" type="text" id="videoUrl">
                </div>
                <button type="button" id="get-info-btn">Find</button>
            </div>
            <div class="video-data">
                <div class="howtouse">
                    <h4>How to use...</h4>
                    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Reprehenderit obcaecati mollitia beatae aut, debitis totam rerum cum et accusamus nulla explicabo, quod eveniet minima voluptate praesentium laborum nesciunt vel perspiciatis?</p>
                </div>
                <div class="loadBox">
                    <div class="loader">
                        <div class="loader__bar"></div>
                        <div class="loader__bar"></div>
                        <div class="loader__bar"></div>
                        <div class="loader__bar"></div>
                        <div class="loader__bar"></div>
                        <div class="loader__ball"></div>
                    </div>
                </div>
                <div class="data">
                    <div class="thumbnail">
                        <img src="" alt="">
                    </div>
                    <div class="info">
                        <h3 class="vidTitle">Lorem, ipsum dolor.</h3>
                        <p class='description'>Lorem ipsum dolor sit amet consectetur adipisicing elit. Soluta, sint.
                        </p>
                    </div>
                </div>
                <div class="controls">
                    <input type="hidden" id="video-url">
                    <div class="btn-group" role="group">
                        <select id="downloadOptions"></select>
                        <button id="downloadBtn">Download</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <span>Made with ðŸ’™ by Farrukh Olimov</span>
            <ul class="links">
                <li class="link">
                    <a href=""><i class="fab fa-telegram-plane"></i></a>
                </li>
                <li class="link">
                    <a href=""><i class="fab fa-instagram"></i></a>
                </li>
                <li class="link">
                    <a href=""><i class="fab fa-facebook"></i></a>
                </li>
                <li class="link">
                    <a href=""><i class="fas fa-globe"></i></a>
                </li>
            </ul>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous">
    </script>

    <script type="text/javascript">
        const host = 'http://localhost:5000/';
        const videoInfo = document.querySelector('#get-info-btn')
        const videoUrl = document.querySelector('#videoUrl')
        const downloadBtn = document.querySelector('#downloadBtn')
        const downloadOptions = document.querySelector('#downloadOptions')
        const videoData = document.querySelector('.data')
        const dataSection = document.querySelector('.video-data')
        const controls = document.querySelector('.controls')
        const howtouse = document.querySelector('.howtouse')
        const loader = document.querySelector('.loadBox')

        videoInfo.addEventListener('click', fetchHandler)
        
        async function fetchHandler(){
            if(videoData.style.display == 'flex' || controls.style.display == 'flex'){
                videoData.style.display = 'none'
                controls.style.display = 'none'
            }
            dataSection.style.height = '185px'
            howtouse.style.display = 'none'
            displayLoading()
            let videoURL = videoUrl.value.trim();
            if (!videoURL) {
                alert('Input youtube link first')
                return;
            }
            fetch(host + 'videoInfo?videoURL=' + videoURL).then(res => {
                return res.json();
            }).then(data => {
                dataSection.style.height = 'auto'
                hideLoading()
                videoData.style.display = 'flex'
                controls.style.display = 'flex'

                console.log(data);
                let detailsNodes = {
                    thumbnail: document.querySelector('.thumbnail img'),
                    title: document.querySelector('.vidTitle'),
                    description: document.querySelector('.description'),
                    videoURL: document.querySelector('#video-url'),
                    downloadOpts: document.querySelector('#downloadOptions')
                }

                let html = '';

                for (let i = 0; i < data.formats.length; i++) {
                    if (data.formats[i].container != 'mp4') {
                        continue;
                    }
                    html += `
                        <option value="${data.formats[i].itag}">
                            ${data.formats[i].container} - ${data.formats[i].qualityLabel}
                        </option>`;

                    detailsNodes.thumbnail.src = data.videoDetails.thumbnails[data.videoDetails
                        .thumbnails.length - 1].url;
                    detailsNodes.title.innerText = data.videoDetails.title;
                    detailsNodes.description.innerText = data.videoDetails.description;
                    detailsNodes.videoURL.value = videoURL;
                    detailsNodes.downloadOpts.innerHTML = html;

                }
            }).catch(err => {
                alert('Something went wrong...')
            })
        }

        downloadBtn.addEventListener('click', () =>{
            let videoURL = document.querySelector('#video-url').value;
            let itag = downloadOptions.value;
            window.open(host + "download?videoURL="+videoURL+"&itag="+itag);

        })

        function displayLoading() {
            loader.classList.add('display')
        }
        function hideLoading() {
            loader.classList.remove('display')
        }
    </script>
</body>

</html>